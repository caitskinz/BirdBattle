<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Bird Bracket Voting</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #5ac5cc;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      margin: 20px;
      font-size: 2em;
      background-color: white;
      border-radius: 20px;
      padding: 10px;
      width: auto;
      align-items: center;
    }

    /* Bracket Layout */
    .bracket {
      display: flex;
      justify-content: center;
      align-items: stretch;
      gap: 40px;
      margin: 30px auto;
      max-width: 1600px;
    }

    .side {
      display: flex;
      flex-direction: row;
      gap: 30px;
      flex: 1;
    }

    .side.left {
      flex-direction: row-reverse;
    }

    .center {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex: 0 0 auto;
    }

    .round {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      flex: 1;
      position: relative;
    }

    .round h2 {
      margin-bottom: 15px;
      font-size: 1.2em;
      text-align: center;
    }

    /* Pair containers */
    .pair {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      gap: 40px;
    }

    /* Connector line for left side */
    .side.left .pair::after {
      content: "";
      position: absolute;
      right: -30px;
      top: 25%;
      height: 50%;
      width: 30px;
      border-right: 2px solid #999;
      border-top: 2px solid #999;
      border-bottom: 2px solid #999;
    }

    /* Connector line for right side */
    .side.right .pair::after {
      content: "";
      position: absolute;
      left: -30px;
      top: 25%;
      height: 50%;
      width: 30px;
      border-left: 2px solid #999;
      border-top: 2px solid #999;
      border-bottom: 2px solid #999;
    }

    /* Match Cards */
    .match {
      width: 220px;
      padding: 15px;
      border: 3px solid #00395d;
      border-radius: 12px;
      background: #fff;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: 0.2s;
    }

    .match.disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .match h3 {
      margin: 5px 0 10px;
      font-size: 1em;
    }

    .match img {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      margin: 5px 0;
      object-fit: cover;
      border: solid 3px #00395d;
    }

    .nominee {
      font-size: 0.8em;
      color: #666;
      display: block;
      margin-bottom: 8px;
    }

    button {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      background: #007BFF;
      color: white;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.2s;
    }

    button:hover:not(:disabled) {
      background: #0056b3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Winner Highlight */
    .winner {
      border-color: #28a745 !important;
      background: #e9f9ef !important;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      max-width: 420px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .modal-content h2 {
      margin-bottom: 15px;
    }

    .modal-content img {
      width: 120px;
      height: 120px;
      margin: 15px;
      cursor: pointer;
      border: 3px solid transparent;
      border-radius: 12px;
      transition: 0.2s;
      object-fit: cover;
    }

    .modal-content img:hover {
      border: 3px solid #007BFF;
    }

    /* üì± Mobile Layout */
    @media (max-width: 768px) {
      .bracket {
        flex-direction: column;
        gap: 20px;
        align-items: center;
        height: auto;
      }

      .side {
        flex-direction: column !important;
        gap: 20px;
        width: 100%;
      }

      .center {
        order: -1;
        width: 100%;
      }

      .round {
        justify-content: flex-start;
        width: 100%;
        align-items: center;
      }

      .match {
        width: 95%;
        max-width: 400px;
      }

      /* Hide connectors on mobile */
      .pair::after {
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <h1>ü•ä üí• üê¶ Battle of the Birds üê¶ üí• ü•ä</h1>
  <div class="bracket">
    <div class="side left">
      <div class="round" id="round3-left">
        <h2>Semifinal</h2>
        <div class="matches"></div>
      </div>
      <div class="round" id="round2-left">
        <h2>Quarterfinals</h2>
        <div class="matches"></div>
      </div>
      <div class="round" id="round1-left">
        <h2>Round 1</h2>
        <div class="matches"></div>
      </div>
    </div>

    <div class="center">
      <div class="round" id="round4">
        <h2>Final</h2>
        <div class="matches"></div>
      </div>
    </div>

    <div class="side right">
      <div class="round" id="round3-right">
        <h2>Semifinal</h2>
        <div class="matches"></div>
      </div>
      <div class="round" id="round2-right">
        <h2>Quarterfinals</h2>
        <div class="matches"></div>
      </div>
      <div class="round" id="round1-right">
        <h2>Round 1</h2>
        <div class="matches"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="voteModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Choose your bird</h2>
      <div id="choices"></div>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSM6C8TDthgQV63gtOA8cJ2_PyF6_9R4zwXVWZyBCs2aeaKMC5m1LfJD9vJYRq14gqixAm2jbvHPDkb/pub?gid=1366198750&single=true&output=csv"; 
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxUDTostkrNZ8FEQV9FHoLqYIr0PkQBlcl2NqUDf88v6iY27FUTV0bcuhn_cFkXeR4sdQ/exec";   

    let currentMatchId = null;

    async function loadMatches() {
      const response = await fetch(SHEET_URL);
      const text = await response.text();

      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows.shift();

      // Clear containers
      ["round1-left", "round2-left", "round3-left",
        "round1-right", "round2-right", "round3-right",
        "round4"].forEach(id => {
          document.querySelector(`#${id} .matches`).innerHTML = "";
        });

      rows.forEach(row => {
        const data = {};
        headers.forEach((h, i) => data[h] = row[i]);

        const matchDiv = document.createElement("div");
        matchDiv.className = "match disabled";
        matchDiv.dataset.date = data.Date;
        matchDiv.dataset.matchid = data.MatchID;

        matchDiv.innerHTML = `
          <h3>Match ${data.MatchID}</h3>
          <img src="${data.EntryA_ImageURL}" alt="${data.EntryA_Name}">
          <div>${data.EntryA_Name}</div>
          <span class="nominee">Nominated by ${data.EntryA_Nominee}</span>
          <img src="${data.EntryB_ImageURL}" alt="${data.EntryB_Name}">
          <div>${data.EntryB_Name}</div>
          <span class="nominee">Nominated by ${data.EntryB_Nominee}</span>
          <button disabled>Vote</button>
        `;

        if (data.Winner && data.Winner.trim() !== "") {
          matchDiv.classList.add("winner");
        }

        let targetId;
        const mid = parseInt(data.MatchID);
        if (mid >= 1 && mid <= 4) targetId = "round1-left";
        else if (mid >= 5 && mid <= 8) targetId = "round1-right";
        else if (mid === 9 || mid === 10) targetId = "round2-left";
        else if (mid === 11 || mid === 12) targetId = "round2-right";
        else if (mid === 13) targetId = "round3-left";
        else if (mid === 14) targetId = "round3-right";
        else if (mid === 15) targetId = "round4";

        const roundContainer = document.querySelector(`#${targetId} .matches`);

        let pair;
        if (roundContainer.lastElementChild &&
          roundContainer.lastElementChild.classList.contains("pair") &&
          roundContainer.lastElementChild.childElementCount < 2) {
          pair = roundContainer.lastElementChild;
        } else {
          pair = document.createElement("div");
          pair.className = "pair";
          roundContainer.appendChild(pair);
        }

        pair.appendChild(matchDiv);
      });

      enableMatches();
    }

    function enableMatches() {
      const today = new Date().toISOString().split('T')[0];

      document.querySelectorAll('.match').forEach(match => {
        const matchDate = match.dataset.date;
        const button = match.querySelector('button');

        if (today === matchDate) {
          match.classList.remove('disabled');
          button.disabled = false;
          button.textContent = "Vote";
          button.addEventListener('click', () => openModal(match));
        } else if (today < matchDate) {
          match.classList.add('disabled');
          button.disabled = true;
          button.textContent = "Opens " + matchDate;
        } else {
          match.classList.add('disabled');
          button.disabled = true;
          button.textContent = "Voting Closed";
        }
      });
    }

    function openModal(match) {
      currentMatchId = match.dataset.matchid;
      const imgs = match.querySelectorAll('img');
      const names = match.querySelectorAll('div');
      const choicesDiv = document.getElementById('choices');
      const modalTitle = document.getElementById('modalTitle');
      choicesDiv.innerHTML = "";

      const previousVote = localStorage.getItem("voted_match_" + currentMatchId);
      if (previousVote) {
        modalTitle.innerText = "You already voted";
        choicesDiv.innerHTML = `<p>‚úÖ You voted for <b>${previousVote}</b></p>`;
        document.getElementById('voteModal').style.display = 'flex';
        return;
      }

      modalTitle.innerText = "Choose your bird";

      [0, 1].forEach(i => {
        const choiceImg = document.createElement('img');
        choiceImg.src = imgs[i].src;
        choiceImg.alt = names[i].innerText;
        choiceImg.dataset.choice = names[i].innerText;
        choiceImg.onclick = () => sendVote(choiceImg);
        choicesDiv.appendChild(choiceImg);
      });

      document.getElementById('voteModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('voteModal').style.display = 'none';
    }

    function sendVote(choiceImg) {
      const choice = choiceImg.dataset.choice;

      const allChoices = document.querySelectorAll('#choices img');
      allChoices.forEach(img => {
        img.style.pointerEvents = "none";
        img.style.opacity = "0.5";
      });

      choiceImg.style.opacity = "1";
      choiceImg.style.border = "3px solid green";

      localStorage.setItem("voted_match_" + currentMatchId, choice);

      fetch(WEBAPP_URL, {
        method: "POST",
        body: JSON.stringify({
          matchId: currentMatchId,
          choice: choice,
          voter: localStorage.getItem("voterId") || ""
        }),
        headers: { "Content-Type": "application/json" }
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === "duplicate") {
            document.getElementById('choices').innerHTML = `<p>‚ö†Ô∏è You already voted in this match.</p>`;
          } else {
            document.getElementById('choices').innerHTML += `<p>‚úÖ You voted for <b>${choice}</b></p>`;
          }
        })
        .catch(err => {
          console.error("Vote failed:", err);
          document.getElementById('choices').innerHTML += `<p style="color:red">‚ùå Vote failed. Please try again.</p>`;
        });
    }

    loadMatches();
  </script>
</body>
</html>
