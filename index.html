<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bird Bracket Voting</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #5ac5cc;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      margin: 20px;
      font-size: 2em;
      background: #fff;
      border-radius: 20px;
      padding: 10px;
    }

    /* ‚úÖ Default: desktop visible, mobile hidden */
    .mobile-rounds {
      display: none !important;
    }
    .bracket {
      display: flex !important;
      justify-content: center;
      align-items: stretch;
      gap: 30px;
      margin: 30px auto;
      max-width: 1600px;
    }

    .side {
      display: flex;
      flex-direction: row;
      gap: 20px;
      flex: 1;
    }

    .side.left {
      flex-direction: row-reverse;
    }

    .center {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex: 0 0 auto;
    }

    .round {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      flex: 1;
      position: relative;
    }

    .round h2 {
      margin-bottom: 10px;
      font-size: 1.1em;
      text-align: center;
    }

    .pair {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      gap: 25px;
    }

    .side.left .pair::after,
    .side.right .pair::after {
      content: "";
      position: absolute;
      top: 25%;
      height: 50%;
      width: 25px;
      border-top: 2px solid #999;
      border-bottom: 2px solid #999;
    }

    .side.left .pair::after {
      right: -25px;
      border-right: 2px solid #999;
    }

    .side.right .pair::after {
      left: -25px;
      border-left: 2px solid #999;
    }

    .match {
      width: 220px;
      padding: 15px;
      border: 3px solid #00395d;
      border-radius: 12px;
      background: #fff;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .match.disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .match h3 {
      margin: 5px 0 10px;
      font-size: 1em;
    }

    .match img {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      margin: 5px 0;
      object-fit: cover;
      border: solid 3px #00395d;
    }

    .nominee {
      font-size: 0.8em;
      color: #666;
      display: block;
      margin-bottom: 8px;
    }

    button {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      background: #007BFF;
      color: white;
      cursor: pointer;
      margin-top: 8px;
    }

    button:hover:not(:disabled) {
      background: #0056b3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .winner {
      border-color: #28a745 !important;
      background: #e9f9ef !important;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      max-width: 420px;
    }

    .modal-content img {
      width: 120px;
      height: 120px;
      margin: 15px;
      cursor: pointer;
      border: 3px solid transparent;
      border-radius: 12px;
      object-fit: cover;
    }

    .modal-content img:hover {
      border: 3px solid #007BFF;
    }

    /* üì± Mobile (‚â§768px): desktop hidden, mobile visible */
    @media (max-width: 768px) {
      .bracket {
        display: none !important;
      }
      .mobile-rounds {
        display: block !important;
        padding: 10px;
      }

      .round-selector {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .round-selector button {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: #00395d;
        color: white;
      }

      .round-selector button.active {
        background: #007BFF;
        border: solid 2px #f6e909;
      }

      .mobile-round {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .mobile-round.active {
        display: flex;
      }

      .match {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 95%;
        max-width: 450px;
        padding: 10px;
      }

      .entry {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        text-align: center;
      }

      .entry img {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        object-fit: cover;
        border: 2px solid #00395d;
        margin-bottom: 5px;
      }

      .entry div {
        font-size: 0.9em;
        font-weight: bold;
      }

      .nominee {
        font-size: 0.7em;
        color: #666;
      }
    }
  </style>
</head>

<body>
  <h1>ü•ä üí• üê¶ Battle of the Birds üê¶ üí• ü•ä</h1>

  <!-- Bracket (desktop) -->
  <div class="bracket">
    <div class="side left">
      <div class="round" id="round3-left">
        <h2>Semifinal</h2>
        <div class="matches"></div>
      </div>
      <div class="round" id="round2-left">
        <h2>Quarterfinals</h2>
        <div class="matches"></div>
      </div>
      <div class="round" id="round1-left">
        <h2>Round 1</h2>
        <div class="matches"></div>
      </div>
    </div>
    <div class="center">
      <div class="round" id="round4">
        <h2>Final</h2>
        <div class="matches"></div>
      </div>
    </div>
    <div class="side right">
      <div class="round" id="round3-right">
        <h2>Semifinal</h2>
        <div class="matches"></div>
      </div>
      <div class="round" id="round2-right">
        <h2>Quarterfinals</h2>
        <div class="matches"></div>
      </div>
      <div class="round" id="round1-right">
        <h2>Round 1</h2>
        <div class="matches"></div>
      </div>
    </div>
  </div>

  <!-- Mobile -->
  <div class="mobile-rounds">
    <div class="round-selector">
      <button onclick="showMobileRound('round1')" class="active">Round 1</button>
      <button onclick="showMobileRound('round2')">Quarterfinals</button>
      <button onclick="showMobileRound('round3')">Semifinals</button>
      <button onclick="showMobileRound('round4')">Final</button>
    </div>
    <div id="mobile-round1" class="mobile-round active">
      <h2>Round 1</h2>
      <div class="matches"></div>
    </div>
    <div id="mobile-round2" class="mobile-round">
      <h2>Quarterfinals</h2>
      <div class="matches"></div>
    </div>
    <div id="mobile-round3" class="mobile-round">
      <h2>Semifinals</h2>
      <div class="matches"></div>
    </div>
    <div id="mobile-round4" class="mobile-round">
      <h2>Final</h2>
      <div class="matches"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="voteModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Choose your bird</h2>
      <div id="choices"></div>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSM6C8TDthgQV63gtOA8cJ2_PyF6_9R4zwXVWZyBCs2aeaKMC5m1LfJD9vJYRq14gqixAm2jbvHPDkb/pub?output=csv"; 
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzGewVgcdwcF82TGM4aVtcR0c3nLHxcZkDOrp79WxQXOtN1AzAcimyDDNezFxnrIPYYgA/exec"; 
    let currentMatchId = null;

    function showMobileRound(round) {
      document.querySelectorAll('.mobile-round').forEach(r => r.classList.remove('active'));
      document.querySelectorAll('.round-selector button').forEach(b => b.classList.remove('active'));
      document.getElementById('mobile-' + round).classList.add('active');
      document.querySelector(`.round-selector button[onclick="showMobileRound('${round}')"]`).classList.add('active');
    }

    function parseCSV(text) {
      return text.trim().split("\n").map(line => {
        const regex = /("([^"]*)"|[^,]+)/g;
        const row = [];
        let match;
        while ((match = regex.exec(line))) {
          row.push(match[2] !== undefined ? match[2] : match[0]);
        }
        return row;
      });
    }

    async function loadMatches() {
      const response = await fetch(SHEET_URL);
      const text = await response.text();
      const rows = parseCSV(text);
      const headers = rows.shift();
      const headerMap = {};
      headers.forEach((h, i) => headerMap[h.trim()] = i);

      ["round1-left","round2-left","round3-left","round1-right","round2-right","round3-right","round4",
      "mobile-round1","mobile-round2","mobile-round3","mobile-round4"].forEach(id => {
        document.querySelector(`#${id} .matches`).innerHTML = "";
      });

      rows.forEach(row => {
        const data = {};
        Object.keys(headerMap).forEach(h => data[h] = row[headerMap[h]] || "");

        const matchDesktop = document.createElement("div");
        matchDesktop.className = "match disabled";
        matchDesktop.dataset.date = data.Date;
        matchDesktop.dataset.matchid = data.MatchID;
        matchDesktop.innerHTML = `
          <h3>Match ${data.MatchID}</h3>
          <img src="${data.EntryA_ImageURL}" alt="${data.EntryA_Name}">
          <div>${data.EntryA_Name}</div>
          <span class="nominee">Nominated by ${data.EntryA_Nominee}</span>
          <img src="${data.EntryB_ImageURL}" alt="${data.EntryB_Name}">
          <div>${data.EntryB_Name}</div>
          <span class="nominee">Nominated by ${data.EntryB_Nominee}</span>
          <button disabled>Vote</button>
        `;

        const matchMobile = document.createElement("div");
        matchMobile.className = "match disabled";
        matchMobile.dataset.date = data.Date;
        matchMobile.dataset.matchid = data.MatchID;
        matchMobile.innerHTML = `
          <div class="entry">
            <img src="${data.EntryA_ImageURL}" alt="${data.EntryA_Name}">
            <div>${data.EntryA_Name}</div>
            <span class="nominee">Nominated by ${data.EntryA_Nominee}</span>
          </div>
          <div class="vote"><button disabled>Vote</button></div>
          <div class="entry">
            <img src="${data.EntryB_ImageURL}" alt="${data.EntryB_Name}">
            <div>${data.EntryB_Name}</div>
            <span class="nominee">Nominated by ${data.EntryB_Nominee}</span>
          </div>
        `;

        let targetId, mobileTarget;
        const mid = parseInt(data.MatchID);
        if (mid >= 1 && mid <= 4) { targetId="round1-left"; mobileTarget="mobile-round1"; }
        else if (mid >= 5 && mid <= 8) { targetId="round1-right"; mobileTarget="mobile-round1"; }
        else if (mid === 9 || mid === 10) { targetId="round2-left"; mobileTarget="mobile-round2"; }
        else if (mid === 11 || mid === 12) { targetId="round2-right"; mobileTarget="mobile-round2"; }
        else if (mid === 13) { targetId="round3-left"; mobileTarget="mobile-round3"; }
        else if (mid === 14) { targetId="round3-right"; mobileTarget="mobile-round3"; }
        else if (mid === 15) { targetId="round4"; mobileTarget="mobile-round4"; }

        const roundContainer = document.querySelector(`#${targetId} .matches`);
        if (roundContainer) {
          let pair = roundContainer.lastElementChild && roundContainer.lastElementChild.classList.contains("pair") && roundContainer.lastElementChild.childElementCount < 2
            ? roundContainer.lastElementChild
            : Object.assign(document.createElement("div"), {className: "pair"});
          if (!roundContainer.lastElementChild || roundContainer.lastElementChild.childElementCount >= 2) roundContainer.appendChild(pair);
          pair.appendChild(matchDesktop);
        }
        document.querySelector(`#${mobileTarget} .matches`).appendChild(matchMobile);
      });

      enableMatches();
    }

    function enableMatches() {
      const today = new Date().toISOString().split('T')[0];
      document.querySelectorAll('.match').forEach(match => {
        const matchDate = match.dataset.date;
        const button = match.querySelector('button');
        if (today === matchDate) {
          match.classList.remove('disabled'); button.disabled=false; button.textContent="Vote";
          button.onclick = () => openModal(match);
        } else if (today < matchDate) {
          button.disabled=true; button.textContent="Opens "+matchDate;
        } else {
          button.disabled=true; button.textContent="Voting Closed";
        }
      });
    }

    function openModal(match) {
      currentMatchId = match.dataset.matchid;
      const imgs = match.querySelectorAll('img');
      const names = match.querySelectorAll('div');
      const choicesDiv = document.getElementById('choices');
      const modalTitle = document.getElementById('modalTitle');
      choicesDiv.innerHTML = "";

      const previousVote = localStorage.getItem("voted_match_" + currentMatchId);
      if (previousVote) {
        modalTitle.innerText = "You already voted";
        choicesDiv.innerHTML = `<p>‚úÖ You voted for <b>${previousVote}</b></p>`;
        document.getElementById('voteModal').style.display = 'flex'; return;
      }

      modalTitle.innerText = "Choose your bird";
      [0,1].forEach(i => {
        const choiceImg = document.createElement('img');
        choiceImg.src = imgs[i].src; choiceImg.alt = names[i].innerText;
        choiceImg.dataset.choice = names[i].innerText;
        choiceImg.onclick = () => sendVote(choiceImg);
        choicesDiv.appendChild(choiceImg);
      });
      document.getElementById('voteModal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('voteModal').style.display='none'; }

    function sendVote(choiceImg) {
      const choice = choiceImg.dataset.choice;
      localStorage.setItem("voted_match_" + currentMatchId, choice);

      fetch(WEBAPP_URL, {
        method:"POST",
        body:JSON.stringify({matchId:currentMatchId, choice:choice, voter:localStorage.getItem("voterId")||""}),
        headers:{"Content-Type":"application/json"}
      })
      .then(res=>res.json())
      .then(data=>{
        const choices = document.getElementById('choices');
        if(data.status==="duplicate"){ choices.innerHTML=`<p>‚ö†Ô∏è You already voted in this match.</p>`; }
        else if(data.status==="success"){ choices.innerHTML=`<p>‚úÖ You voted for <b>${choice}</b></p>`; }
        else { choices.innerHTML=`<p style="color:red">‚ùå Error: ${data.message}</p>`; }
      })
      .catch(err=>{
        console.error("Vote failed:",err);
        document.getElementById('choices').innerHTML=`<p style="color:red">‚ùå Vote failed. Please try again.</p>`;
      });
    }

    loadMatches();
  </script>
</body>
</html>
